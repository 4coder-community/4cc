name: Download

on:
  push:
    branches:
      - master
      - develop
    tags:
      - v*

jobs:
  build_4cc:
    uses: ./.github/workflows/build.yml

  publish_release:
    if: github.ref_type == 'tag' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop'
    needs: build_4cc
    name: Upload Release
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ github.token }}
      RELEASE_NAME: ${{ github.ref_type == 'tag' && github.ref_name || github.ref == 'refs/heads/develop' && 'unstable' || 'latest' }}
      RELEASE_TITLE: ${{ github.ref_type == 'tag' && github.ref_name || github.ref == 'refs/heads/develop' && 'Unstable' || 'Latest' }}
      RELEASE_TARGET: ${{ github.sha }}
      RELEASE_PRERELEASE_FLAG: ${{ github.ref == 'refs/heads/develop' && '--prerelease' || '' }}
      
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    - name: Create Release Exists
      run: |
        if ! gh release view "$RELEASE_NAME" --repo "${{ github.repository }}"; then
          gh release create "$RELEASE_NAME" --repo "${{ github.repository }}" --title "$RELEASE_TITLE" --target "$RELEASE_TARGET" $RELEASE_PRERELEASE_FLAG --notes " "
        fi

    - name: Retarget Rolling Release
      if: github.ref_type != 'tag'
      run: gh release edit "$RELEASE_NAME" --repo "${{ github.repository }}" --title "$RELEASE_TITLE" --target "$RELEASE_TARGET"

    - name: Mark Unstable As Prerelease
      if: github.ref == 'refs/heads/develop'
      run: gh release edit "$RELEASE_NAME" --repo "${{ github.repository }}" --prerelease

    - name: Download 4cc Artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts_dir
        pattern: 4cc-*

    - run: |
        cd artifacts_dir
        for f in ./* ; do zip -r "$f.zip" $f ; done;

    - name: Upload to Release
      run: gh release upload "$RELEASE_NAME" artifacts_dir/4cc-*.zip --repo "${{ github.repository }}" --clobber
